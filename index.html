<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>2EMME — Guide (Mobile)</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    /* Mobile-first styles */
    :root{
      --c-ottanio:#00383D;
      --c-sugar:#BFEBFF;
      --c-white:#FFFFFF;
      --glass-bg:rgba(255,255,255,0.04);
      --glass-border:rgba(191,235,255,0.08);
      --radius:14px;
      --touch:16px;
    }
    html,body{height:100%;margin:0;font-family:Inter, 'Plus Jakarta Sans', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:var(--c-white);background:linear-gradient(180deg,#002e2f,#00383d 60%);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    /* Intro overlay (mobile friendly) */
    #intro-overlay{position:fixed;inset:0;display:flex;align-items:flex-end;justify-content:center;padding:20px;box-sizing:border-box;z-index:9999}
    .intro-card{width:100%;max-width:820px;border-radius:var(--radius);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--glass-border);backdrop-filter:blur(8px);padding:18px;box-sizing:border-box;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
    .intro-row{display:flex;gap:12px;align-items:center}
    .intro-left{flex:0 0 92px;text-align:left}
    .intro-left .temp{font-weight:800;font-size:28px;color:var(--c-sugar)}
    .intro-main{flex:1}
    .intro-title{font-family: 'Playfair Display', serif;font-size:22px;margin:0 0 6px 0;color:var(--c-sugar)}
    .intro-sub{font-size:15px;margin:0;color:rgba(255,255,255,0.92)}
    .intro-actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:12px;padding:12px 14px;font-weight:700;font-size:15px;border:none;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,#BF953F,#FCF6BA);color:#000}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--c-white)}
    .muted{color:rgba(255,255,255,0.78);font-size:13px}
    .small-muted{color:rgba(255,255,255,0.6);font-size:12px}
    /* App shell mobile */
    #main-app{display:none;height:100vh;overflow:auto;padding-bottom:80px;box-sizing:border-box}
    header.app-header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.06));backdrop-filter:blur(6px);padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:44px;height:44;border-radius:10px;background:#002b2c;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--c-sugar)}
    .brand h1{margin:0;font-size:16px;font-weight:800}
    .brand p{margin:0;font-size:11px;color:var(--c-sugar)}
    .header-actions{margin-left:auto;display:flex;gap:8px}
    .container{padding:14px}
    .panel{background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:12px;padding:12px;margin-bottom:12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    select,input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--c-white);font-size:15px;-webkit-appearance:none}
    .row{display:flex;gap:8px}
    .row .col{flex:1}
    .planner-result{margin-top:10px}
    .route-box{background:rgba(0,0,0,0.16);border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.03)}
    .timeline{margin-top:8px}
    .tl-item{border-left:3px solid rgba(191,235,255,0.08);padding:10px 12px;margin-bottom:10px;border-radius:8px;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent)}
    .service-box .svc{margin-bottom:12px}
    .svc .title{font-weight:700}
    footer{position:fixed;left:0;right:0;bottom:0;padding:10px 14px;background:linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.12));text-align:center;font-size:13px;color:rgba(255,255,255,0.7)}
    /* responsive larger screens keep single-col but center */
    @media(min-width:821px){
      #intro-overlay{align-items:center}
      .intro-card{max-width:760px}
      .container{max-width:980px;margin:0 auto;padding:18px}
      #main-app{padding-bottom:100px}
    }
  </style>
</head>
<body>

  <!-- INTRO (mobile-first, no date/birthday logic) -->
  <div id="intro-overlay" role="dialog" aria-modal="true">
    <div class="intro-card" aria-label="Intro 2EMME Guide">
      <div class="intro-row">
        <div class="intro-left">
          <div class="small-muted">Meteo locale</div>
          <div id="intro-weather-temp" class="temp">--°C</div>
          <div id="intro-weather-desc" class="small-muted">Caricamento…</div>
        </div>
        <div class="intro-main">
          <h2 class="intro-title">Ciao Giada</h2>
          <p class="intro-sub">Are u ready to explore?<br><span class="muted">Il meteo locale appare se autorizzi la posizione. Se preferisci, apri senza posizione.</span></p>

          <div class="intro-actions">
            <button id="enter-guide" class="btn btn-primary">Enter The Guide</button>
            <button id="enter-no-geo" class="btn btn-ghost">Apri senza posizione</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="main-app" aria-hidden="true">
    <header class="app-header">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-gem"></i></div>
        <div>
          <h1>2EMME — Guide</h1>
          <p>Interactive planner — concierge & itineraries</p>
        </div>
      </div>
      <div class="header-actions" aria-hidden="false">
        <button id="open-planner" class="btn btn-primary">Planner</button>
      </div>
    </header>

    <div class="container">
      <!-- Planner panel -->
      <section class="panel" aria-labelledby="planner-title">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div id="planner-title" style="font-weight:800">Concierge Planner</div>
          <div class="small-muted">Timezone: Europe/Rome</div>
        </div>

        <div style="margin-top:10px" class="controls">
          <select id="city-select" aria-label="Seleziona città">
            <option value="nyc">New York</option>
            <option value="boston">Boston</option>
          </select>

          <select id="cat-select" aria-label="Seleziona categoria">
            <option value="explore">Explore / Musei</option>
            <option value="food">Food</option>
            <option value="shopping">Shopping</option>
          </select>

          <button id="load-options" class="btn btn-primary" style="flex:1;min-width:120px">Carica proposte</button>
        </div>

        <div id="planner-area" style="margin-top:12px;display:none">
          <div style="display:flex;gap:8px;flex-direction:column">
            <label class="small-muted">Museo / Attrazione</label>
            <select id="museum-select" aria-label="Museo"></select>

            <div style="display:flex;gap:8px;margin-top:8px">
              <select id="museum-hours" aria-label="Ore" style="max-width:120px">
                <option value="1">1h</option>
                <option value="2" selected>2h</option>
                <option value="3">3h</option>
              </select>
              <button id="gen-itinerary" class="btn btn-primary" style="flex:1">Genera itinerario</button>
              <button id="concierge-suggest" class="btn btn-ghost" style="flex:1">Genera programma</button>
            </div>
          </div>

          <div id="planner-result" class="planner-result"></div>
        </div>
      </section>

      <!-- Timeline / Feed -->
      <section class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Timeline</div>
          <div class="small-muted">Le tue attività</div>
        </div>
        <div id="timeline-content" class="timeline" style="margin-top:8px">Timeline non generata.</div>
      </section>

      <!-- Services -->
      <section class="panel service-box">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Servizi locali & Prenotazioni</div>
          <div class="small-muted">Demo disponibilità</div>
        </div>
        <div id="service-box" style="margin-top:10px"></div>
      </section>

      <div class="panel">
        <div style="font-weight:800">Suggerimenti rapidi</div>
        <ul style="margin:10px 0 0 16px;color:rgba(255,255,255,0.8);font-size:13px">
          <li>Genera itinerario → aggiungi alla timeline → stampa voucher.</li>
          <li>Se la prenotazione fallisce, il sistema propone alternative walk-in vicino.</li>
        </ul>
      </div>
    </div>
  </div>

  <footer>© 2026 2EMME Real Estate — Internal Use Only</footer>

  <script>
    /* ===========================
       Mobile-first Guide (no date/bday logic)
       - kept core DB + itinerary + concierge + reservation simulation
       - removed any date-checks, birthday UI and force-bday
       - geolocation/meteo optional (uses open-meteo)
       =========================== */

    // Minimal DOM helpers
    const $ = id => document.getElementById(id);

    /* ---------- Database (essenziale, esteso lato client) ---------- */
    const DB = {
      museums: [
        {id:1, city:'nyc', name:'MoMA', zone:'Midtown', overview:'Il MoMA è il museo di riferimento per arte moderna e contemporanea. Sale dedicate a Van Gogh, Picasso, Warhol.', highlights:[
          {title:'The Starry Night', author:'Vincent van Gogh (1889)', desc:'Esempio di pennellata espressiva e movimento del cielo.'},
          {title:"Les Demoiselles d'Avignon", author:'Pablo Picasso (1907)', desc:'Svolta cubista e rottura prospettiva.'}
        ], must:['Starry Night','Picasso — demoiselles'], alternative:['Collezioni temporanee','Bookshop'] , full:['Tour cronologico della collezione permanente + mostra temporanea']},
        {id:2, city:'nyc', name:'The Met', zone:'Upper East Side', overview:'La collezione è enorme: antichità, pittura europea, americana, arti decorative.', highlights:[
          {title:'The Harvesters', author:'Pieter Bruegel (1565)', desc:'Ritratto della vita contadina con ricchezza di dettaglio.'}
        ], must:['European Paintings','American Wing'], alternative:['The Cloisters'], full:['Percorso 3h selezionato']},
        {id:3, city:'nyc', name:'Poster House', zone:'Chelsea', overview:'Museo dedicato alla grafica del poster, storia della stampa e design.' , highlights:[
          {title:'Advertising Posters', author:'Various', desc:'Evoluzione grafica e tecniche di stampa.'}
        ], must:['Sezione storica poster'], alternative:['Workshop temporanei'], full:['Visita 1h–1.5h']},
        {id:4, city:'boston', name:'MFA', zone:'Fenway', overview:'Collezioni di impressionisti e arte asiatica; Monet, Degas tra i punti forti.', highlights:[
          {title:'Claude Monet works', author:'Claude Monet', desc:'Studio della luce e serie dei Water Lilies.'}
        ], must:['Impressionisti','Degas'], alternative:['American Wing'], full:['Percorso 2–3h']},
        {id:5, city:'boston', name:'MIT Museum', zone:'Cambridge', overview:'Tech, robotica e mostre su AI e innovazione.', highlights:[
          {title:'AI & Robotics', author:'MIT teams', desc:'Installazioni interattive e prototipi.'}
        ], must:['Robotica','AI exhibits'], alternative:['Workshops'], full:['Visita 1–2h']}
      ],
      explore: {
        nyc: { classic:[{name:'MoMA'},{name:'The Met'},{name:'High Line'},{name:'Grand Central'},{name:'Whitney'}], niche:[{name:'Poster House'},{name:'Mercer Labs'},{name:'Domino Park'},{name:'Eavesdrop'},{name:'Chelsea galleries'}]},
        boston:{ classic:[{name:'MFA'},{name:'Freedom Trail'},{name:'Public Library'},{name:'Quincy Market'},{name:'Harvard campus'}], niche:[{name:'MIT Museum'},{name:'SoWa Market'},{name:'Mapparium'},{name:'Gardner Museum'},{name:'Hidden Rooftops'}]}
      },
      food: {
        nyc:{ classic:[{name:'Carbone'},{name:"Katz's Deli"},{name:'Balthazar'},{name:'Keens'},{name:'Polo Bar'}], niche:[{name:'Laser Wolf'},{name:'Misi'},{name:'Four Horsemen'},{name:'Dimes Square'},{name:'Hidden supper clubs'}]},
        boston:{ classic:[{name:'Union Oyster House'},{name:'Neptune Oyster'},{name:'Contessa'},{name:'Tatte'},{name:'Capital Grille'}], niche:[{name:'Mikiya Wagyu'},{name:'Hecate'},{name:'Krasi'},{name:'Comfort Kitchen'},{name:'Tonino'}]}
      },
      shopping: {
        nyc:{ classic:[{name:'Strand'},{name:'Fishs Eddy'},{name:'Economy Candy'},{name:'Chelsea Market'},{name:'Brookfield'}], niche:[{name:'Dover Street'},{name:'Showfields'},{name:'Kith'},{name:'Popups'},{name:'Vintage LES'}]},
        boston:{ classic:[{name:'Brattle'},{name:'Beacon Hill'},{name:'Harvard Sq'},{name:'Prudential'},{name:'Newbury'}], niche:[{name:'SoWa'},{name:'Independent shops'},{name:'Artisan markets'},{name:'Concept stores'},{name:'Sneaker boutiques'}]}
      },
      services: {
        nyc:{ food:[{name:'Carbone', zone:'Village', link:'https://resy.com/cities/new-york-ny/venues/carbone'},{name:"Katz's Deli", zone:'LES', link:'https://katzsdelicatessen.com/'}],
              coffee:[{name:'Blue Bottle', zone:'Chelsea'},{name:'Stumptown', zone:'Village'}],
              spa:[{name:'Great Jones Spa', zone:'NoHo'},{name:'AIRE Ancient Baths', zone:'Tribeca'}],
              manicure:[{name:'Paintbox', zone:'SoHo'},{name:'Olive & June', zone:'Chelsea'}]
            },
        boston:{ food:[{name:'Union Oyster House', zone:'North End', link:'https://www.unionoysterhouse.com'},{name:'Neptune Oyster', zone:'North End'}],
                 coffee:[{name:'Tatte', zone:'Back Bay'}],
                 spa:[{name:'Exhale Back Bay', zone:'Back Bay'},{name:'G2O', zone:'Seaport'}],
                 manicure:[{name:'Paint Nail Bar', zone:'Back Bay'}]
               }
      }
    };

    /* ---------- Meteo (opzionale) ---------- */
    async function fetchWeather(lat, lon){
      try{
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=Europe%2FRome`;
        const r = await fetch(url);
        if(!r.ok) throw new Error('Meteo non disponibile');
        return await r.json();
      }catch(e){ return null; }
    }

    async function tryShowWeatherWithGeo(){
      let coords = null;
      try{
        coords = await new Promise((res,rej)=> navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude,lon:p.coords.longitude}), e=>rej(e), {timeout:7000}));
      }catch(e){ coords=null; }
      if(!coords){
        // fallback to city selection default (NYC)
        coords = {lat:40.7128, lon:-74.0060};
      }
      const data = await fetchWeather(coords.lat, coords.lon);
      if(data && data.current_weather){
        const c = data.current_weather;
        $('intro-weather-temp').innerText = Math.round(c.temperature) + '°C';
        $('intro-weather-desc').innerText = `Vento ${Math.round(c.windspeed)} km/h`;
      } else {
        $('intro-weather-temp').innerText = '--°C';
        $('intro-weather-desc').innerText = 'Meteo non disponibile';
      }
    }

    /* ---------- UI behavior ---------- */
    window.addEventListener('load', async ()=>{
      // show intro: weather attempted but no date/bday logic
      try { await tryShowWeatherWithGeo(); } catch(e){ /* ignore */ }
    });

    $('enter-guide').addEventListener('click', ()=>{ $('intro-overlay').style.display='none'; $('main-app').style.display='block'; $('main-app').scrollTop=0; });
    $('enter-no-geo').addEventListener('click', ()=>{ $('intro-overlay').style.display='none'; $('main-app').style.display='block'; });

    // planner controls
    $('load-options').addEventListener('click', ()=>{
      const city = $('city-select').value;
      const cat = $('cat-select').value;
      if(cat === 'explore'){
        // populate museum-select with curated + detailed
        const curated = (DB.explore[city].classic || []).concat(DB.explore[city].niche || []);
        const sel = $('museum-select'); sel.innerHTML = '';
        curated.forEach(it => { const opt = document.createElement('option'); opt.value = it.name; opt.text = it.name; sel.appendChild(opt); });
        // also detailed museums
        DB.museums.filter(m => m.city === city).forEach(m => {
          if(!Array.from(sel.options).some(o => o.value === m.name)){
            const opt = document.createElement('option'); opt.value=m.name; opt.text=m.name; sel.appendChild(opt);
          }
        });
        $('planner-area').style.display = 'block';
      } else {
        // fill service-box
        const box = $('service-box'); box.innerHTML = '';
        const list = (cat === 'food') ? (DB.food[city].classic.concat(DB.food[city].niche)) : (DB.shopping[city].classic.concat(DB.shopping[city].niche));
        list.slice(0,8).forEach(item => {
          const el = document.createElement('div'); el.className='svc';
          el.innerHTML = `<div class="title">${item.name}</div><div class="small-muted" style="margin-top:6px">${item.zone||''} ${item.desc?('• '+(item.desc||'')):''}</div>
            <div style="margin-top:8px"><button class="btn btn-primary" style="width:100%" onclick="checkReservation('${city}','${escapeHtml(item.name)}','${escapeHtml(item.zone||'')}','${escapeHtml(item.link||'')}')">Verifica prenotazione</button></div>`;
          box.appendChild(el);
        });
        $('planner-area').style.display = 'none';
      }
    });

    $('gen-itinerary').addEventListener('click', ()=> {
      const museumName = $('museum-select').value;
      const hours = parseInt($('museum-hours').value,10) || 2;
      if(!museumName) return alert('Seleziona un museo/attrazione.');
      const m = DB.museums.find(x => x.name === museumName) || {name:museumName, overview:'', highlights:[], must:[], alternative:[], full:[]};
      const it = buildMuseumItinerary(m, hours);
      renderItinerary(it,m);
    });

    $('concierge-suggest').addEventListener('click', ()=>{
      const museumName = $('museum-select').value;
      const hours = parseInt($('museum-hours').value,10) || 2;
      const city = $('city-select').value;
      if(!museumName) return alert('Seleziona un museo per il concierge.');
      const m = DB.museums.find(x => x.name === museumName) || {name:museumName, overview:'', highlights:[], must:[], alternative:[], full:[]};
      const it = buildMuseumItinerary(m, hours);
      const plan = conciergePlan(city, m, it);
      renderConcierge(plan);
    });

    /* ---------- Itinerary generator ---------- */
    function buildMuseumItinerary(museum, hours){
      const start = new Date(); start.setHours(10,30,0,0);
      const steps = [];
      const per = Math.max(1, Math.min(3, hours));
      const highlights = museum.highlights || [];
      for(let i=0;i<per && i<highlights.length;i++){
        const h = highlights[i];
        steps.push({time: timeAdd(start, i*40), title:`Focus: ${h.title}`, note:`Autore: ${h.author}. ${h.desc}`});
      }
      steps.push({time: timeAdd(start, per*40), title:'Panoramica collezione', note: museum.overview || ''});
      steps.push({time: timeAdd(start, (per+1)*25), title:'Percorso alternativo', note: (museum.alternative || []).join(' • ') || 'Passeggiata consigliata nei dintorni'});
      return {museum: museum.name || '', hours: per, steps, must: museum.must || [], alt: museum.alternative || [], full: museum.full || []};
    }
    function timeAdd(base, minutes){ return new Date(base.getTime() + minutes*60000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

    function renderItinerary(it, museumObj){
      const box = $('planner-result'); box.innerHTML = '';
      const head = document.createElement('div'); head.innerHTML = `<div style="font-weight:800">${museumObj.name} — Itinerario ${it.hours}h</div><div class="small-muted" style="margin-top:6px">${museumObj.overview||''}</div>`;
      box.appendChild(head);

      // tabs buttons
      const tabs = document.createElement('div'); tabs.style.display='flex'; tabs.style.gap='8px'; tabs.style.marginTop='10px';
      ['Must-to-see','Alternativo','Completo'].forEach(t=>{
        const btn = document.createElement('button'); btn.className='btn btn-ghost'; btn.style.flex='1'; btn.innerText=t;
        btn.addEventListener('click', ()=> {
          const routeArea = document.getElementById('route-area');
          if(routeArea){ routeArea.remove(); }
          const r = document.createElement('div'); r.id='route-area'; r.className='route-box'; r.style.marginTop='10px';
          if(t==='Must-to-see'){
            (it.must||[]).forEach(item => { const p=document.createElement('div'); p.style.marginTop='8px'; p.innerHTML=`<div style="font-weight:600">• ${item}</div>`; r.appendChild(p); });
          } else if (t==='Alternativo'){
            (it.alt||[]).forEach(item => { const p=document.createElement('div'); p.style.marginTop='8px'; p.innerHTML=`<div style="font-weight:600">• ${item}</div>`; r.appendChild(p); });
          } else {
            (it.full||[]).forEach(item => { const p=document.createElement('div'); p.style.marginTop='8px'; p.innerHTML=`<div style="font-weight:600">• ${item}</div>`; r.appendChild(p); });
          }
          box.appendChild(r);
        });
        tabs.appendChild(btn);
      });
      box.appendChild(tabs);

      // default show Must
      const r0 = document.createElement('div'); r0.id='route-area'; r0.className='route-box'; r0.style.marginTop='10px';
      (it.must || []).forEach(item => { const p=document.createElement('div'); p.style.marginTop='8px'; p.innerHTML=`<div style="font-weight:600">• ${item}</div>`; r0.appendChild(p); });
      box.appendChild(r0);

      // steps summary & actions
      const stepsDiv = document.createElement('div'); stepsDiv.style.marginTop='12px';
      it.steps.forEach(s => {
        const el = document.createElement('div'); el.className='route-box'; el.style.marginTop='8px';
        el.innerHTML = `<div style="font-weight:700">${s.time} — ${s.title}</div><div class="small-muted" style="margin-top:6px">${s.note || ''}</div>`;
        stepsDiv.appendChild(el);
      });
      box.appendChild(stepsDiv);

      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='10px';
      const addBtn = document.createElement('button'); addBtn.className='btn btn-primary'; addBtn.style.flex='1'; addBtn.innerText='Aggiungi alla timeline';
      addBtn.addEventListener('click', ()=>{ addToTimeline(`${museumObj.name} — Itinerario ${it.hours}h`, it.steps); alert('Itinerario aggiunto alla timeline'); });
      const editBtn = document.createElement('button'); editBtn.className='btn btn-ghost'; editBtn.style.flex='1'; editBtn.innerText='Personalizza';
      editBtn.addEventListener('click', ()=> alert('Editor orari non attivo nella demo mobile'));
      actions.appendChild(addBtn); actions.appendChild(editBtn);
      box.appendChild(actions);
    }

    /* ---------- Concierge ---------- */
    function conciergePlan(city, museumObj, itinerary){
      const start = new Date(); start.setHours(10,30,0,0);
      const steps = itinerary.steps.slice();
      const foodCandidates = DB.services[city].food || [];
      const lunch = foodCandidates.find(f => f.zone && museumObj.zone && f.zone === museumObj.zone) || foodCandidates[0] || {name:'Ristorante locale', zone:''};
      steps.push({time: timeAdd(new Date(start.getTime()), itinerary.hours*60), title:`Pranzo consigliato: ${lunch.name}`, note:`Zona: ${lunch.zone} • Prenotazione consigliata`});
      const coffee = (DB.services[city].coffee || [])[0] || {name:'Caffè vicino'};
      steps.push({time: timeAdd(new Date(start.getTime()), itinerary.hours*60 + 90), title:`Caffè: ${coffee.name}`, note:'Sosta per scappare dal freddo'});
      const spa = (DB.services[city].spa || [])[0] || {name:'Centro benessere'};
      steps.push({time: timeAdd(new Date(start.getTime()), itinerary.hours*60 + 160), title:`Relax: ${spa.name}`, note:'Massaggio o trattamento (verifica disponibilità)'});
      const mani = (DB.services[city].manicure || [])[0] || {name:'Manicure locale'};
      steps.push({time: timeAdd(new Date(start.getTime()), itinerary.hours*60 + 260), title:`Manicure: ${mani.name}`, note:'Appuntamento o walk-in possibile'});
      return {city, museum: museumObj.name, steps, recommendations:{lunch, coffee, spa, manicure:mani}};
    }

    function renderConcierge(plan){
      const box = $('planner-result'); box.innerHTML = '';
      const head = document.createElement('div'); head.innerHTML = `<div style="font-weight:800">Programma Concierge — ${plan.museum} (${plan.city})</div><div class="small-muted" style="margin-top:6px">Generato automaticamente</div>`; box.appendChild(head);
      plan.steps.forEach(s => {
        const el = document.createElement('div'); el.className='route-box'; el.style.marginTop='10px';
        el.innerHTML = `<div style="font-weight:700">${s.time} — ${s.title}</div><div class="small-muted" style="margin-top:6px">${s.note}</div>`;
        box.appendChild(el);
      });
      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='10px';
      const add = document.createElement('button'); add.className='btn btn-primary'; add.style.flex='1'; add.innerText='Aggiungi piano';
      add.addEventListener('click', ()=>{ addToTimeline(`Concierge — ${plan.museum}`, plan.steps); alert('Piano aggiunto alla timeline'); });
      const check = document.createElement('button'); check.className='btn btn-ghost'; check.style.flex='1'; check.innerText='Verifica locali';
      check.addEventListener('click', ()=> { checkReservation(plan.city, plan.recommendations.lunch.name, plan.recommendations.lunch.zone, plan.recommendations.lunch.link); setTimeout(()=>checkReservation(plan.city, plan.recommendations.spa.name, plan.recommendations.spa.zone, ''), 400); });
      actions.appendChild(add); actions.appendChild(check);
      box.appendChild(actions);
    }

    /* ---------- Timeline ---------- */
    function addToTimeline(title, steps){
      const container = $('timeline-content');
      if(container.innerText.trim() === 'Timeline non generata.') container.innerHTML = '';
      const wrapper = document.createElement('div'); wrapper.className='tl-item';
      const head = document.createElement('div'); head.style.fontWeight='800'; head.innerText = title; wrapper.appendChild(head);
      steps.forEach(s => {
        const it = document.createElement('div'); it.style.marginTop='8px'; it.innerHTML = `<div style="font-weight:600">${s.time} — ${s.title}</div><div class="small-muted" style="margin-top:4px">${s.note||''}</div>`; wrapper.appendChild(it);
      });
      container.prepend(wrapper);
    }

    /* ---------- Reservation simulation + walk-in ---------- */
    function checkReservation(city, name, zone, link){
      const box = $('service-box');
      const node = document.createElement('div'); node.className='svc'; node.innerHTML = `<div class="title">${name}</div><div class="small-muted" style="margin-top:6px">Controllo disponibilità in corso…</div>`;
      box.prepend(node);
      setTimeout(()=>{
        const ok = Math.random() > 0.35; // 65% chance available
        node.innerHTML = `<div class="title">${name}</div>`;
        if(ok){
          node.innerHTML += `<div class="small-muted">✅ Posti disponibili.</div>`;
          if(link) node.innerHTML += `<div style="margin-top:8px"><a href="${link}" target="_blank" class="btn btn-primary" style="width:100%">Apri prenotazione</a></div>`;
          else node.innerHTML += `<div style="margin-top:8px"><button class="btn btn-primary" style="width:100%" onclick="fakeBook('${escapeHtml(name)}')">Prenota (simulato)</button></div>`;
        } else {
          node.innerHTML += `<div class="small-muted">❌ Non disponibile per la fascia scelta.</div>`;
          const alt = suggestAlternative(city, zone, name);
          node.innerHTML += `<div class="small-muted" style="margin-top:8px">Alternativa walk-in: <strong>${alt.name}</strong> — ${alt.zone||''}</div>`;
          node.innerHTML += `<div style="margin-top:8px"><button class="btn btn-ghost" style="width:100%" onclick="openMap('${escapeHtml(alt.name)}','${escapeHtml(alt.zone||'')}')">Vai (map demo)</button></div>`;
        }
      }, 700 + Math.random()*800);
    }
    function fakeBook(name){ alert('Prenotazione simulata per: ' + name + '\n(Operazione demo — non effettua prenotazioni reali).'); }
    function suggestAlternative(city, zone, originalName){
      const pool = [].concat(DB.services[city].food || [], DB.services[city].coffee || [], DB.services[city].spa || [], DB.services[city].manicure || []);
      let candidates = pool.filter(p => p.name !== originalName && (p.zone === zone || !zone));
      if(!candidates.length) candidates = pool.filter(p => p.name !== originalName);
      return candidates[Math.floor(Math.random()*candidates.length)] || {name:'Locale vicino', zone:'vicino'};
    }
    function openMap(name, zone){ alert(`Mappa demo: ${name} (${zone}) — integrazione reale con GoogleMaps/Leaflet disponibile.`); }

    /* ---------- Helpers ---------- */
    function escapeHtml(s){ return String(s||'').replace(/"/g,'&quot;').replace(/'/g,"\\'"); }
  </script>
</body>
</html>
